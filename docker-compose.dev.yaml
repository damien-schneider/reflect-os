# Development Docker Compose
# Usage: bun dev (automatically starts these services)
# Or manually: docker compose -f docker-compose.dev.yaml up -d
#
# Includes:
# - PostgreSQL database (port 5430 for backward compatibility)
# - Drizzle Gateway for database management
# - Internal network for service communication

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16.2-alpine
    container_name: reflect-dev-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: user
      POSTGRES_DB: postgres
      POSTGRES_PASSWORD: password
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
      - "-c"
      - "max_replication_slots=10"
      - "-c"
      - "max_wal_senders=10"
      - "-c"
      - "shared_buffers=1GB"
    ports:
      - "5430:5432"
    volumes:
      - reflect_dev_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - reflect-dev-network

  # Drizzle Gateway
  drizzle-gateway:
    image: ghcr.io/drizzle-team/gateway:latest
    container_name: reflect-dev-drizzle-gateway
    restart: unless-stopped
    environment:
      PORT: "4983"
      STORE_PATH: "/app"
      MASTERPASS: ${MASTERPASS:-defaultdevpassword}
    ports:
      - "4983:4983"
    volumes:
      - reflect_dev_drizzle_gateway:/app
    networks:
      - reflect-dev-network
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  reflect_dev_pgdata:
    name: reflect-dev-postgres-data
  reflect_dev_drizzle_gateway:
    name: reflect-dev-drizzle-gateway-data

networks:
  reflect-dev-network:
    driver: bridge
    name: reflect-dev-network