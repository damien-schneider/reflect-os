# Docker Compose for Dokploy deployment
#
# Required Environment Variables (set in Dokploy UI):
#   POSTGRES_PASSWORD - Database password
#   BETTER_AUTH_SECRET - Auth secret key
#   ZERO_AUTH_SECRET - Zero sync auth secret
#   PUBLIC_URL - Frontend URL (e.g., https://beta.reflet.app)
#   ZERO_SERVER_URL - Zero cache public URL (e.g., https://beta-zero.reflet.app)
#
# Dokploy Domain Setup:
#   web        → beta.reflet.app:3000
#   backend    → beta-backend.reflet.app:3001
#   zero-cache → beta-zero.reflet.app:4848
#
# Optional:
#   POSTGRES_USER - Database username (default: reflect_user)
#   POLAR_ACCESS_TOKEN - For billing integration
#   POLAR_WEBHOOK_SECRET - For billing webhooks
#   POLAR_ENVIRONMENT - sandbox or production
#   RESEND_API_KEY - For sending emails (verification, notifications)
#   EMAIL_FROM_ADDRESS - Sender email (e.g., noreply@yourdomain.com)
#   EMAIL_FROM_NAME - Sender display name

# TODO: Improvements: use secrets instead of environment vars for sensitive data (keeping the build check and t3-oss/env-core validation working.)

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-reflect_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: reflect
    volumes:
      # Named volume for Dokploy backup management
      - postgres_data:/var/lib/postgresql/data
    # Required for Zero replication
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
      - "-c"
      - "max_replication_slots=10"
      - "-c"
      - "max_wal_senders=10"
    healthcheck:
      test:
        ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-reflect_user} -d reflect"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - reflect-network

  # Database Migrations (init container - runs once and exits)
  migrations:
    build:
      context: .
      dockerfile: Dockerfile.migrations
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      ZERO_UPSTREAM_DB: postgres://${POSTGRES_USER:-reflect_user}:${POSTGRES_PASSWORD}@postgres:5432/reflect
    networks:
      - reflect-network
    # Init container: runs once, must complete successfully
    restart: "no"
    # Deploy configuration for compatibility with various orchestrators
    deploy:
      restart_policy:
        condition: none

  # Zero Cache Server (sync server for Rocicorp Zero)
  zero-cache:
    build:
      context: .
      dockerfile: Dockerfile.zero-cache
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    expose:
      - "4848"
    environment:
      # Database connections
      ZERO_UPSTREAM_DB: postgres://${POSTGRES_USER:-reflect_user}:${POSTGRES_PASSWORD}@postgres:5432/reflect
      ZERO_CVR_DB: postgres://${POSTGRES_USER:-reflect_user}:${POSTGRES_PASSWORD}@postgres:5432/reflect
      ZERO_CHANGE_DB: postgres://${POSTGRES_USER:-reflect_user}:${POSTGRES_PASSWORD}@postgres:5432/reflect
      # Authentication
      ZERO_AUTH_SECRET: ${ZERO_AUTH_SECRET:?ZERO_AUTH_SECRET is required}
      ZERO_ADMIN_PASSWORD: ${ZERO_ADMIN_PASSWORD:-admin}
      # Replica file for local caching
      ZERO_REPLICA_FILE: /data/zero_replica.db
      # Logging
      ZERO_LOG_LEVEL: ${ZERO_LOG_LEVEL:-info}
      LOG_LEVEL: ${ZERO_LOG_LEVEL:-info}
      ZERO_NUM_SYNC_WORKERS: ${ZERO_NUM_SYNC_WORKERS:-2}
      NODE_ENV: production
    volumes:
      # Named volume for zero-cache replica data
      - zero_data:/data
    networks:
      - reflect-network

  # Backend API Server (Hono)
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    expose:
      - "3001"
    environment:
      # Database connection
      ZERO_UPSTREAM_DB: postgres://${POSTGRES_USER:-reflect_user}:${POSTGRES_PASSWORD}@postgres:5432/reflect
      # Auth secrets
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:?BETTER_AUTH_SECRET is required}
      BETTER_AUTH_URL: ${PUBLIC_URL:?PUBLIC_URL is required - set in Dokploy UI}
      ZERO_AUTH_SECRET: ${ZERO_AUTH_SECRET}
      # Polar billing (optional)
      POLAR_ACCESS_TOKEN: ${POLAR_ACCESS_TOKEN:-}
      POLAR_WEBHOOK_SECRET: ${POLAR_WEBHOOK_SECRET:-}
      POLAR_ENVIRONMENT: ${POLAR_ENVIRONMENT:-sandbox}
      # Email (required - for verification & notifications)
      RESEND_API_KEY: ${RESEND_API_KEY:?RESEND_API_KEY is required}
      EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:?EMAIL_FROM_ADDRESS is required}
      EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-Reflet}
      # Server config
      PORT: "3001"
      NODE_ENV: production
    networks:
      - reflect-network

  # Web Application (Vite/React frontend)
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      zero-cache:
        condition: service_started
      backend:
        condition: service_started
    expose:
      - "3000"
    environment:
      # Zero server URL (public URL for frontend WebSocket connection)
      VITE_PUBLIC_ZERO_SERVER: ${ZERO_SERVER_URL:?ZERO_SERVER_URL is required - set in Dokploy UI}
      # Email verification flag (must match backend RESEND_API_KEY presence)
      VITE_PUBLIC_REQUIRE_EMAIL_VERIFICATION: ${REQUIRE_EMAIL_VERIFICATION:-true}
      # Internal API URL for server-side proxy (Docker network, NOT browser)
      INTERNAL_API_URL: http://backend:3001
      # Server-side environment
      ZERO_UPSTREAM_DB: postgres://${POSTGRES_USER:-reflect_user}:${POSTGRES_PASSWORD}@postgres:5432/reflect
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      BETTER_AUTH_URL: ${PUBLIC_URL}
      ZERO_AUTH_SECRET: ${ZERO_AUTH_SECRET}
      NODE_ENV: production
    networks:
      - reflect-network

  # Drizzle Gateway for database management
  # Note: Database connection must be configured via the web UI after deployment.
  # Access the gateway at https://drizzle.reflet.app and use:
  #   - Host: postgres (internal Docker network hostname)
  #   - Port: 5432
  #   - Database: reflect
  #   - User: (your POSTGRES_USER value, default: reflect_user)
  #   - Password: (your POSTGRES_PASSWORD value)
  drizzle-gateway:
    image: ghcr.io/drizzle-team/gateway:latest
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PORT: "4983"
      STORE_PATH: "/app"
      MASTERPASS: ${MASTERPASS:?MASTERPASS is required}
    volumes:
      - drizzle_gateway_data:/app
    networks:
      - reflect-network
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.drizzle-gateway.rule=Host(`drizzle.reflet.app`)"
        - "traefik.http.routers.drizzle-gateway.tls=true"
        - "traefik.http.routers.drizzle-gateway.tls.certresolver=letsencrypt"
        - "traefik.http.services.drizzle-gateway.loadbalancer.server.port=4983"

volumes:
  # PostgreSQL data - backs up the entire database
  postgres_data:
    name: reflect-postgres-data
  # Zero cache replica - can be regenerated but speeds up restarts
  zero_data:
    name: reflect-zero-data
  # Drizzle Gateway data - stores gateway configuration
  drizzle_gateway_data:
    name: reflect-drizzle-gateway-data

networks:
  reflect-network:
    driver: bridge
